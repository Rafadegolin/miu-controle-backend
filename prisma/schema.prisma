datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==================== MODELOS ====================

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  passwordHash     String           @map("password_hash")
  fullName         String           @map("full_name")
  phone            String?
  avatarUrl        String?          @map("avatar_url")
  subscriptionTier SubscriptionTier @default(FREE) @map("subscription_tier")
  emailVerified    Boolean          @default(false) @map("email_verified")
  twoFactorEnabled Boolean          @default(false) @map("two_factor_enabled")
  lastLoginAt      DateTime?        @map("last_login_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  accounts                Account[]
  categories              Category[]
  transactions            Transaction[]
  budgets                 Budget[]
  goals                   Goal[]
  rules                   CategorizationRule[]
  refreshTokens           RefreshToken[]
  notificationLogs        NotificationLog[]
  subscription            UserSubscription?
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  notifications           Notification[]
  recurringTransactions   RecurringTransaction[]
  preferredCurrency       String                   @default("BRL") @map("preferred_currency")
  auditLogs               AuditLog[]

  // AI Relations
  aiConfig                  UserAiConfig?
  aiUsageMetrics            AiUsageMetric[]
  aiCategorizationFeedbacks AiCategorizationFeedback[]
  predictionHistory         PredictionHistory[]
  categoryPredictions       CategoryPrediction[]
  monthlyReports            MonthlyReport[]
  anomalyDetections         AnomalyDetection[]
  lastAiTrainingAt          DateTime?                  @map("last_ai_training_at")

  emergencyFund             EmergencyFund?
  proactiveAlerts           ProactiveAlert[]
  recommendations       Recommendation[]
  healthScore           HealthScore?
  achievements          UserAchievement[]
  
  @@map("users")
}

// ... (keep existing enums and models) ...

// ==================== HEALTH SCORE & GAMIFICATION (Issue #49) ====================

model HealthScore {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // PontuaÃ§Ãµes Parciais
  totalScore        Int      // 0-1000
  consistencyScore  Int      // 0-300
  budgetScore       Int      // 0-250
  goalsScore        Int      // 0-200
  emergencyScore    Int      // 0-150
  diversityScore    Int      // 0-100
  
  level             String   // CRITICAL, ATTENTION, HEALTHY, GOOD, EXCELLENT (Armazenado como string para flexibilidade ou criar Enum)
  
  // AI Insights
  aiInsights        String?  @map("ai_insights") @db.Text // Texto gerado pela IA com dicas
  lastAiAnalysisAt  DateTime? @map("last_ai_analysis_at")
  
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("health_scores")
}

model Achievement {
  id          String   @id @default(uuid())
  code        String   @unique // ex: FIRST_TRANSACTION, WEEK_STREAK
  name        String
  description String
  icon        String
  points      Int      // Pontos de "XP" ou apenas indicativo
  
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String      @map("achievement_id")
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  unlockedAt    DateTime    @default(now()) @map("unlocked_at")

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

enum SubscriptionTier {
  FREE
  PRO
  FAMILY
}

model Account {
  id                   String      @id @default(uuid())
  userId               String      @map("user_id")
  user                 User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                 String
  type                 AccountType
  bankCode             String?     @map("bank_code")
  initialBalance       Decimal     @default(0) @map("initial_balance") @db.Decimal(15, 2)
  currentBalance       Decimal     @default(0) @map("current_balance") @db.Decimal(15, 2)
  currency             String      @default("BRL")
  color                String      @default("#6366F1")
  icon                 String?
  isActive             Boolean     @default(true) @map("is_active")
  openBankingConnected Boolean     @default(false) @map("open_banking_connected")
  openBankingConsentId String?     @map("open_banking_consent_id")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  transactions Transaction[]

  recurringTransactions RecurringTransaction[]

  @@index([userId, isActive])
  @@map("accounts")
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
}

model Category {
  id              String       @id @default(uuid())
  userId          String?      @map("user_id")
  user            User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  type            CategoryType
  parentId        String?      @map("parent_id")
  parent          Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[]   @relation("CategoryHierarchy")
  color           String       @default("#94A3B8")
  icon            String?
  isSystem        Boolean      @default(false) @map("is_system")
  isEssential     Boolean      @default(true) @map("is_essential") // Issue #45
  budgetAllocated Decimal?     @map("budget_allocated") @db.Decimal(15, 2)
  createdAt       DateTime     @default(now()) @map("created_at")

  transactions Transaction[]
  budgets      Budget[]
  rules        CategorizationRule[]

  // AI Relations
  originalFeedbacks  AiCategorizationFeedback[] @relation("OriginalCategory")
  correctedFeedbacks AiCategorizationFeedback[] @relation("CorrectedCategory")
  predictions        CategoryPrediction[] // 

  recurringTransactions RecurringTransaction[]

  @@index([userId, type])
  @@map("categories")
}

//  PLANO DE OBJETIVOS (Issue #45)
model GoalPlan {
  id             String   @id @default(uuid())
  goalId         String   @unique @map("goal_id")
  goal           Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  monthlyDeposit Decimal  @map("monthly_deposit") @db.Decimal(15,2)
  isViable       Boolean  @map("is_viable")
  
  // Plano de AÃ§Ã£o (JSON)
  actionPlan     Json     @map("action_plan") 

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  @@map("goal_plans")
}

enum CategoryType {
  EXPENSE
  INCOME
  TRANSFER
}

model Transaction {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId         String            @map("account_id")
  account           Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  categoryId        String?           @map("category_id")
  category          Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  type              TransactionType // <-- CORRIGIDO: era CategoryType, agora Ã© TransactionType
  amount            Decimal           @db.Decimal(15, 2)
  description       String
  merchant          String?
  date              DateTime
  isRecurring       Boolean           @default(false) @map("is_recurring")
  recurrencePattern String?           @map("recurrence_pattern")
  tags              String[]
  notes             String?
  location          Json?
  receiptUrl        String?           @map("receipt_url")
  status            TransactionStatus @default(COMPLETED)
  source            TransactionSource @default(MANUAL)
  notificationHash  String?           @unique @map("notification_hash")

  // AI Fields
  aiCategorized Boolean? @default(false) @map("ai_categorized")
  aiConfidence  Decimal? @map("ai_confidence") @db.Decimal(3, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  goalContributions      GoalContribution[]
  notificationLog        NotificationLog?
  categorizationFeedback AiCategorizationFeedback?
  detectedAnomalies      AnomalyDetection[]

  recurringTransactionId String?               @map("recurring_transaction_id")
  recurringTransaction   RecurringTransaction? @relation("RecurringSource", fields: [recurringTransactionId], references: [id], onDelete: SetNull)

  @@index([userId, date(sort: Desc)])
  @@index([accountId])
  @@index([categoryId])
  @@index([userId, date(sort: Desc), type])
  @@index([accountId, status, date(sort: Desc)])
  @@index([categoryId, date(sort: Desc)])
  @@index([userId, source, createdAt(sort: Desc)])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TransactionSource {
  MANUAL
  NOTIFICATION
  OPEN_BANKING
  IMPORTED
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId      String       @map("category_id")
  category        Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  amount          Decimal      @db.Decimal(15, 2)
  period          BudgetPeriod @default(MONTHLY)
  startDate       DateTime     @map("start_date")
  endDate         DateTime?    @map("end_date")
  alertPercentage Int          @default(80) @map("alert_percentage")
  createdAt       DateTime     @default(now()) @map("created_at")

  @@unique([userId, categoryId, period, startDate])
  @@index([userId, period, startDate])
  @@index([userId, period, startDate(sort: Desc), endDate(sort: Desc)])
  @@map("budgets")
}

enum BudgetPeriod {
  MONTHLY
  WEEKLY
  YEARLY
}

model Goal {
  id            String     @id @default(uuid())
  userId        String     @map("user_id")
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  targetAmount  Decimal    @map("target_amount") @db.Decimal(15, 2)
  currentAmount Decimal    @default(0) @map("current_amount") @db.Decimal(15, 2)
  targetDate    DateTime?  @map("target_date")
  color         String     @default("#10B981")
  icon          String?
  priority      Int        @default(3)
  status        GoalStatus @default(ACTIVE)

  // ðŸ†• HIERARQUIA DE OBJETIVOS (Issue #65)
  parentId             String?     @map("parent_id")
  parent               Goal?       @relation("GoalHierarchy", fields: [parentId], references: [id])
  children             Goal[]      @relation("GoalHierarchy")
  
  hierarchyLevel       Int         @default(0) @map("hierarchy_level")
  isBlocked            Boolean     @default(false) @map("is_blocked")
  distributionStrategy GoalDistributionStrategy @default(PROPORTIONAL) @map("distribution_strategy")
  
  // ðŸ†• PLANO DE OBJETIVOS (Issue #45)
  plan                 GoalPlan?

  // ðŸ†• CAMPOS DE IMAGEM
  imageUrl      String? @map("image_url")
  imageKey      String? @map("image_key")
  imageMimeType String? @map("image_mime_type")
  imageSize     Int?    @map("image_size")

  // ðŸ†• LINKS DE COMPRA (JSON Array)
  purchaseLinks Json? @map("purchase_links")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  contributions GoalContribution[]
  emergencyFunds EmergencyFund[]

  @@index([userId, status])
  @@index([userId, status, createdAt(sort: Desc)])
  @@index([parentId]) // Index for hierarchy traversals
  @@map("goals")
}

enum GoalDistributionStrategy {
  PROPORTIONAL
  SEQUENTIAL
  PRIORITY
  MANUAL
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model GoalContribution {
  id            String       @id @default(uuid())
  goalId        String       @map("goal_id")
  goal          Goal         @relation(fields: [goalId], references: [id], onDelete: Cascade)
  transactionId String?      @map("transaction_id")
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  amount        Decimal      @db.Decimal(15, 2)
  date          DateTime
  createdAt     DateTime     @default(now()) @map("created_at")

  @@map("goal_contributions")
}

model CategorizationRule {
  id             String            @id @default(uuid())
  userId         String            @map("user_id")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId     String            @map("category_id")
  category       Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  conditionType  RuleConditionType @map("condition_type")
  conditionValue String            @map("condition_value")
  priority       Int               @default(100)
  isActive       Boolean           @default(true) @map("is_active")
  matchCount     Int               @default(0) @map("match_count")
  createdAt      DateTime          @default(now()) @map("created_at")

  @@index([userId, isActive, priority])
  @@map("categorization_rules")
}

enum RuleConditionType {
  CONTAINS
  STARTS_WITH
  ENDS_WITH
  REGEX
}

model UserSubscription {
  id                     String             @id @default(uuid())
  userId                 String             @unique @map("user_id")
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                   SubscriptionTier
  status                 SubscriptionStatus
  paymentProvider        String             @default("ABACATEPAY") @map("payment_provider")
  externalSubscriptionId String?            @map("external_subscription_id")
  amount                 Decimal            @db.Decimal(10, 2)
  currency               String             @default("BRL")
  billingCycle           BillingCycle       @default(MONTHLY) @map("billing_cycle")
  currentPeriodStart     DateTime           @map("current_period_start")
  currentPeriodEnd       DateTime           @map("current_period_end")
  trialEndsAt            DateTime?          @map("trial_ends_at")
  cancelledAt            DateTime?          @map("cancelled_at")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")

  @@index([status])
  @@map("user_subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model NotificationLog {
  id               String             @id @default(uuid())
  userId           String             @map("user_id")
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationHash String             @unique @map("notification_hash")
  rawContent       String             @map("raw_content")
  parsedData       Json?              @map("parsed_data")
  bankDetected     String?            @map("bank_detected")
  amountDetected   Decimal?           @map("amount_detected") @db.Decimal(15, 2)
  transactionId    String?            @unique @map("transaction_id")
  transaction      Transaction?       @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  processingStatus NotificationStatus @default(PENDING) @map("processing_status")
  errorMessage     String?            @map("error_message")
  receivedAt       DateTime           @default(now()) @map("received_at")
  processedAt      DateTime?          @map("processed_at")

  @@index([userId, receivedAt(sort: Desc)])
  @@map("notification_logs")
}

enum NotificationStatus {
  PENDING
  PROCESSED
  FAILED
  DUPLICATE
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Campos de sessÃ£o
  deviceInfo String?   @map("device_info")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  lastUsedAt DateTime? @map("last_used_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType @map("type")
  title     String
  message   String
  data      Json? // Dados adicionais (budgetId, goalId, etc)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

enum NotificationType {
  BUDGET_ALERT // OrÃ§amento atingiu % de alerta
  BUDGET_EXCEEDED // OrÃ§amento estourado
  GOAL_ACHIEVED // Meta atingida
  GOAL_MILESTONE // Meta atingiu milestone (25%, 50%, 75%)
  BILL_DUE // Conta a vencer
  SYSTEM // NotificaÃ§Ã£o do sistema
}

model RecurringTransaction {
  id                String              @id @default(uuid())
  userId            String              @map("user_id")
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId         String              @map("account_id")
  account           Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  categoryId        String?             @map("category_id")
  category          Category?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  type              TransactionType
  amount            Decimal             @db.Decimal(15, 2)
  description       String
  merchant          String?
  frequency         RecurrenceFrequency
  interval          Int                 @default(1) // A cada X dias/semanas/meses
  dayOfMonth        Int?                @map("day_of_month") // Dia do mÃªs (1-31) para MONTHLY/YEARLY
  dayOfWeek         Int?                @map("day_of_week") // Dia da semana (0-6, 0=Domingo) para WEEKLY
  startDate         DateTime            @map("start_date")
  endDate           DateTime?           @map("end_date") // Null = sem data final
  lastProcessedDate DateTime?           @map("last_processed_date") // Ãšltima vez que gerou transaÃ§Ã£o
  nextOccurrence    DateTime            @map("next_occurrence") // PrÃ³xima data de ocorrÃªncia
  isActive          Boolean             @default(true) @map("is_active")
  autoCreate        Boolean             @default(true) @map("auto_create") // Gerar automaticamente ou notificar
  tags              String[]
  notes             String?
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  generatedTransactions Transaction[] @relation("RecurringSource")

  @@index([userId, isActive, nextOccurrence])
  @@index([nextOccurrence, isActive])
  @@map("recurring_transactions")
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model Currency {
  id        String   @id @default(uuid())
  code      String   @unique // ISO 4217: USD, EUR, BRL, etc
  name      String // DÃ³lar Americano, Euro, Real
  symbol    String // $, â‚¬, R$
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  exchangeRatesFrom ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo   ExchangeRate[] @relation("ToCurrency")

  @@map("currencies")
}

model ExchangeRate {
  id             String   @id @default(uuid())
  fromCurrencyId String   @map("from_currency_id")
  fromCurrency   Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id], onDelete: Cascade)
  toCurrencyId   String   @map("to_currency_id")
  toCurrency     Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id], onDelete: Cascade)
  rate           Decimal  @db.Decimal(18, 6) // Taxa de conversÃ£o com 6 casas decimais
  date           DateTime @default(now())
  source         String   @default("MANUAL") // MANUAL, API, SYSTEM

  @@unique([fromCurrencyId, toCurrencyId, date])
  @@index([fromCurrencyId, toCurrencyId])
  @@index([date(sort: Desc)])
  @@map("exchange_rates")
}

// ==================== AUDITORIA ====================

model AuditLog {
  id     String  @id @default(uuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action   String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, REGISTER
  entity   String // TRANSACTION, ACCOUNT, BUDGET, GOAL, CATEGORY, USER, RECURRING_TRANSACTION
  entityId String? @map("entity_id")

  // Snapshot before/after para rastreabilidade completa
  before Json? // Estado anterior (para UPDATE/DELETE)
  after  Json? // Estado posterior (para CREATE/UPDATE)

  // Metadata de seguranÃ§a
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  // Indexes para performance de queries
  @@index([userId, createdAt(sort: Desc)])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model MonthlyReport {
  id     String   @id @default(uuid())
  userId String   @map("user_id")
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month  DateTime // Primeiro dia do mÃªs referente ao relatÃ³rio

  // MÃ©tricas Principais
  totalIncome  Decimal @map("total_income") @db.Decimal(15, 2)
  totalExpense Decimal @map("total_expense") @db.Decimal(15, 2)
  balance      Decimal @db.Decimal(15, 2)
  savingsRate  Decimal @map("savings_rate") @db.Decimal(5, 2) // % Economizado

  // Detalhes JSON
  topCategories Json // Ranking de gastos
  anomalies     Json // Despesas fora do padrÃ£o (> 2 StdDev)
  trends        Json // TendÃªncias (Crescimento/Queda)
  insights      Json // Frases geradas (ex: "Gasto em Lazer aumentou 50%")

  // ComparaÃ§Ãµes JSON
  comparisonPrev Json // { incomeDiff: %, expenseDiff: %, balanceDiff: % } vs MÃªs Anterior
  comparisonAvg  Json // { ... } vs MÃ©dia 6 Meses

  generatedAt DateTime @default(now()) @map("generated_at")

  @@unique([userId, month])
  @@index([userId, month])
  @@map("monthly_reports")
}

// ==================== AI SYSTEM ====================

model UserAiConfig {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ðŸ”‘ API Keys Management
  // FREE tier: User provides their own keys (encrypted)
  openaiApiKeyEncrypted String? @map("openai_api_key_encrypted")
  geminiApiKeyEncrypted String? @map("gemini_api_key_encrypted") // ðŸ†•

  // PRO/FAMILY tier: Use corporate keys from env vars
  usesCorporateKey Boolean @default(false) @map("uses_corporate_key") // ðŸ†•

  // ConfiguraÃ§Ãµes
  isAiEnabled       Boolean @default(true) @map("is_ai_enabled")
  monthlyTokenLimit Int?    @default(1000000) @map("monthly_token_limit") // 1M tokens (FREE only)

  // Provider preferences (Granular per feature)
  categorizationModel String @default("gpt-4o-mini") @map("categorization_model")
  analyticsModel      String @default("gemini-1.5-flash") @map("analytics_model")
  recommendationModel String @default("gpt-4o-mini") @map("recommendation_model")
  // Models suportados na UI: 
  // - gpt-4o-mini, gpt-4o
  // - gemini-1.5-flash, gemini-1.5-pro

  // Metadata
  lastTestedAt DateTime? @map("last_tested_at")
  isKeyValid   Boolean   @default(true) @map("is_key_valid")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_ai_configs")
}

model AiUsageMetric {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Feature que usou AI
  feature AiFeatureType

  // MÃ©tricas de uso
  model            String // "gpt-4o-mini", "gpt-4-vision", etc
  promptTokens     Int     @map("prompt_tokens")
  completionTokens Int     @map("completion_tokens")
  totalTokens      Int     @map("total_tokens")
  estimatedCost    Decimal @map("estimated_cost") @db.Decimal(10, 6) // em USD

  // Context
  relatedEntityId String? @map("related_entity_id") // transactionId, etc
  success         Boolean @default(true)
  errorMessage    String? @map("error_message")

  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([userId, feature])
  @@map("ai_usage_metrics")
}

enum AiFeatureType {
  CATEGORIZATION
  PREDICTIVE_ANALYTICS // ðŸ†•
  ANOMALY_DETECTION // ðŸ†•
  RECOMMENDATIONS // ðŸ†•
  OCR
  BANK_NOTIFICATION
  ASSISTANT
}

model AiCategorizationFeedback {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId String      @unique @map("transaction_id")
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // Categoria original (sugerida pela IA)
  originalCategoryId String?   @map("original_category_id")
  originalCategory   Category? @relation("OriginalCategory", fields: [originalCategoryId], references: [id], onDelete: SetNull)

  // Categoria corrigida (pelo usuÃ¡rio)
  correctedCategoryId String   @map("corrected_category_id")
  correctedCategory   Category @relation("CorrectedCategory", fields: [correctedCategoryId], references: [id], onDelete: Cascade)

  // MÃ©tricas
  aiConfidence Decimal @map("ai_confidence") @db.Decimal(3, 2)
  wasCorrect   Boolean @map("was_correct") // true se correÃ§Ã£o == original

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("ai_categorization_feedbacks")
}

// ðŸ†• HistÃ³rico de previsÃµes
model PredictionHistory {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados da previsÃ£o
  predictionType String   @map("prediction_type") // MONTHLY_FORECAST, GOAL_FORECAST, TREND
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")

  // PrevisÃ£o gerada
  predictedIncome   Decimal? @map("predicted_income") @db.Decimal(15, 2)
  predictedExpenses Decimal? @map("predicted_expenses") @db.Decimal(15, 2)
  predictedBalance  Decimal? @map("predicted_balance") @db.Decimal(15, 2)
  confidence        Decimal  @map("confidence") @db.Decimal(3, 2) // 0.00 - 1.00

  // Breakdown por categoria (JSON)
  categoryBreakdown Json? @map("category_breakdown")

  // Metadata
  algorithm String // WEIGHTED_MOVING_AVG, LINEAR_REGRESSION, AI_ENHANCED
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, predictionType, createdAt(sort: Desc)])
  @@map("prediction_history")
}

// ðŸ†• DetecÃ§Ã£o de anomalias
model AnomalyDetection {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId String?      @map("transaction_id")
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  // Tipo de anomalia
  anomalyType  String  @map("anomaly_type") // HIGH_VALUE, UNUSUAL_TIME, NEW_MERCHANT, FREQUENCY_SPIKE
  severity     String // LOW, MEDIUM, HIGH, CRITICAL
  anomalyScore Decimal @map("anomaly_score") @db.Decimal(3, 2) // 0.00 - 1.00

  // Detalhes da anomalia
  description   String
  expectedValue Decimal? @map("expected_value") @db.Decimal(15, 2)
  actualValue   Decimal? @map("actual_value") @db.Decimal(15, 2)
  deviation     Decimal? @map("deviation") @db.Decimal(15, 2) // Percentual de desvio

  // Contexto histÃ³rico
  historicalAverage Decimal? @map("historical_average") @db.Decimal(15, 2)
  historicalStdDev  Decimal? @map("historical_std_dev") @db.Decimal(15, 2)

  // Analise da IA
  aiAnalysis String? @map("ai_analysis") @db.Text

  // Status
  isNotified  Boolean   @default(false) @map("is_notified")
  isDismissed Boolean   @default(false) @map("is_dismissed")
  dismissedAt DateTime? @map("dismissed_at")

  detectedAt DateTime @default(now()) @map("detected_at")

  @@index([userId, severity, isDismissed])
  @@index([userId, detectedAt(sort: Desc)])
  @@map("anomaly_detections")
}

// ðŸ†• PrevisÃ£o por Categoria (Issue #47)
model CategoryPrediction {
  id         String   @id @default(uuid())
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month      DateTime // O mÃªs para o qual esta previsÃ£o Ã© (ex: 2025-02-01)

  predicted Decimal  @db.Decimal(15, 2)
  actual    Decimal? @db.Decimal(15, 2) // Preenchido apÃ³s o fechamento do mÃªs

  confidence Decimal  @db.Decimal(5, 2) // 0-100%
  lowerBound Decimal? @map("lower_bound") @db.Decimal(15, 2)
  upperBound Decimal? @map("upper_bound") @db.Decimal(15, 2)

  factors Json // { seasonality: 1.2, events: ["Natal"] }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, categoryId, month])
  @@index([userId, month])
  @@map("category_predictions")
}

// ðŸ†• COLCHÃƒO FINANCEIRO (Issue #51)
model EmergencyFund {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetAmount        Decimal  @map("target_amount") @db.Decimal(15, 2)
  currentAmount       Decimal  @default(0) @map("current_amount") @db.Decimal(15, 2)
  monthsCovered       Decimal  @default(0) @map("months_covered") @db.Decimal(5, 2)
  recommendation      String?  @db.Text
  
  monthlyContribution Decimal? @map("monthly_contribution") @db.Decimal(15, 2)
  linkedGoalId        String?  @map("linked_goal_id")
  linkedGoal          Goal?    @relation(fields: [linkedGoalId], references: [id], onDelete: SetNull)
  isActive            Boolean  @default(true) @map("is_active")

  withdrawals         EmergencyFundWithdrawal[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("emergency_funds")
}

// ðŸ†• RECOMENDAÃ‡Ã•ES (Issue #50)
model Recommendation {
  id            String              @id @default(uuid())
  userId        String              @map("user_id")
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          RecommendationType
  category      String?             // "Gastos", "Investimentos", "OrÃ§amento", etc.
  title         String
  description   String
  impact        Float               // Economia/melhoria estimada (R$)
  difficulty    Int                 // 1-5 (1=FÃ¡cil, 5=DifÃ­cil)
  priority      Int                 // Score calculado (0-200)
  status        RecommendationStatus @default(ACTIVE)
  
  appliedAt     DateTime?           @map("applied_at")
  dismissedAt   DateTime?           @map("dismissed_at")
  expiresAt     DateTime?           @map("expires_at")
  
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([userId, priority(sort: Desc)])
  @@map("recommendations")
}

enum RecommendationType {
  REDUCE_EXPENSE
  OPTIMIZE_BUDGET
  SAVINGS_OPPORTUNITY
  RISK_ALERT
  SUBSCRIPTION_REVIEW
}

enum RecommendationStatus {
  ACTIVE
  APPLIED
  DISMISSED
  EXPIRED
}


model EmergencyFundWithdrawal {
  id          String        @id @default(uuid())
  fundId      String        @map("fund_id")
  fund        EmergencyFund @relation(fields: [fundId], references: [id], onDelete: Cascade)
  amount      Decimal       @db.Decimal(15, 2)
  reason      String
  approved    Boolean       @default(false)
  createdAt   DateTime      @default(now()) @map("created_at")

  @@map("emergency_fund_withdrawals")
}

// ðŸ†• ALERTAS PROATIVOS (Issue #48)
model ProactiveAlert {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String        // NEGATIVE_BALANCE, BILL_DUE, BUDGET_WARNING, POSITIVE_STREAK
  priority    AlertPriority
  message     String
  aiInsight   String?       @map("ai_insight") // Texto gerado pela IA
  actionable  Boolean       @default(false)
  actionUrl   String?       @map("action_url")
  dismissed   Boolean       @default(false)
  read        Boolean       @default(false)
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([userId, dismissed])
  @@index([userId, priority])
  @@map("proactive_alerts")
}

enum AlertPriority {
  CRITICAL
  WARNING
  INFO
  POSITIVE
}
